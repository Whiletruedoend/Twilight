# Twilight

<img src="https://i.imgur.com/Q2Lhx58.png"></img>

P.S. Список последних изменений можно посмотреть <a href="https://github.com/Whiletruedoend/Twilight/blob/master/update_log.md">тут</a>

## Идея

Недавно задумался над реализацией блогов в разных платформах, и пришёл к следующим проблемам:
 
 * Первая, это то что нет единой площадки куда можно складывать контент;
 * Вторая, проблема в том что все сидят в разных местах;
 
    из этих двух вытекает:
 
 * Третья - глупость самому постить одно и то же в разные места;
 * Четвёртая - нужно самому сидеть в других платформах;
 
 Поэтому было принято написать что-то вроде агрегатора статей. Всё просто - пишешь пост - он разлетается по разным платформам. Схема будет выглядеть примерно так:
 
 <img src="https://i.imgur.com/ffeGQGF.png"></img>
 
 Хочу отметить, это не окончательный вариант, т.е. помимо поста в разные платформы планируется так же реализовать отправку поста в БД, и оттуда по другим платформам. Но сейчас хотя бы сделать так.
 
 На схеме видно что есть каналы на платформах которые принадлежат владельцу, доступ рядовому пользователю осуществляется с помощью rss токена. Поясняю: каждый зарегистрировавшейся пользователь получает свой токен и использует его для получения новостей с RSS. Это даёт два преимущества:
 
 1) Персонализация с помощью тегов контента, который пользователь хочет видеть;
 2) Ограничение автором прав доступа на некоторые статьи;
 
 Конечно, если мы говорим о размещении статей на других открытых платформах, ограничение прав особо не имеет смысла, однако целью автора не было построение полностью изолированной среды с контролем каждой выходной ноды, хотя бы потому что это практически нереализуемо.
 
 На текущий момент таблица моделей выглядит примерно так:
 
 <img src="https://i.imgur.com/9wzdDVj.png"></img>
 
 ## Текущие возможности/Планы
 * <s>Система регистрации/авторизации (devise);</s>
 * <s>Простенькая каптча при регистрации/авторизации;</s>
 * <s>Реализация создания, просмотра постов;</s>
 * <s>Кнопочка 'читать далее' на постах;</s>
 * <s>Поддержка отображения разметки (redcarpet);</s>
 * <s>Тэги для поста и пользователя, возможность настраивать в RSS;</s>
 * <s>Почти красивый markdown-редактор при создании статьи;</s>
 * <s>Удаление/Обновление тэгов;</s>
 * <s>Починить фронтенд;</s>
 * <s>Оповещение администратору в telegram при регистрации пользователя;</s>
 * <s>Придумать что написать на главной странице;</s>
 * <s>Реализовать пост в telegram, matrix;</s>
 * <s>Банан за байпасс rss токена;</s>
 * <s>Возможность редактировать статью с дальнейшей отправки правок платформам;</s>
 * Возможность постить и редактировать посты из платформы (???);
 * Страница помощи для юзера по настройке канала для разных платформ (???);
 * Запрет на посещение сайта с плохими (спам) IP; (???)
 * Система инвайтов; (???)
 
 Список возможно будет пополняться...
 
 ## Поддержка платформ
 
 * Telegram: 
   * Отправка в платформы: Да
   * Редактирование, удаление: Да
   * Отправка из платформы: Нет
   * Поддержка комментариев: Да
   * Поддержка аттачменов: картинки, видео, аудио, файлы
   
 * Matrix: 
   * Отправка в платформы: Да
   * Редактирование, удаление: Да
   * Отправка из платформы: Нет
   * Поддержка аттачменов: картинки, видео, аудио, файлы
 
 Пока что всё
 
 ## Установка
 
  * Ставим ruby;
  * Ставим проект: 
  
    ```ssh
     git clone https://github.com/Whiletruedoend/Twilight
     cd Twilight/
     yarn install --check-files
     bundle install
     rails db:migrate
    ```
     
  * Настраиваем: `credentials.yml`
  * Запускаем: `rails s`
  
Теперь сайт будет доступен по адресу: `http://localhost:3080`

## Настройка
Все настройки делаются через консоль (`rails c`)
  * После регистрации делаем себя админом (для публикации постов и всего-всего):
      ```ssh
       User.last.update(is_admin: true)
      ```
  * Создаём платформы (на данный момент поддерживается только telegram и matrix)
      ```ssh
       Platform.create(title: "telegram")
       Platform.create(title: "matrix")
      ```
### Комментарии
Чтобы работали комментарии в Telegram, для этого необходимо:
1. Включить их (`credentials --> telegram --> comments: true`);
2. Проверить настройки приватности бота;
3. Добавить бота в чат с комментариями;

**Далее, запустить отдельно бота в папке с проектом командой:**

`rake telegram:bot:poller` (для прода не забыть указать `RAILS_ENV=production` в начале)
### Matrix
 Краткая инструкция по настройке matrix. Все поля для изменений находятся в `credentials.yml`
 
 0. Убеждаемся что создана платформа matrix. Или: `Platform.create(title: "matrix")`
 1. В колонке `matrix` меняем `enabled` с `false` на `true`
 2. Доступ осуществляется через access_token. Его получение через клиент Element: `Все настройки -> Помощь & О программе --> *в самом низу* Токен доступа`
 3. Для получения ID комнаты, создаём комнату, после чего ПКМ на комнате и `Настройки --> Подробности --> и тут 'Внутренний ID комнаты'`
### fail2ban
Для возможности блокировки IP адресов тех, кто пытается сбрутофорсить RSS токен, используется [fail2ban](https://www.dmosk.ru/instruktions.php?object=fail2ban). Инструкция:
* Поставить пакет fail2ban;
* Настроить `credentials.yml`: выставить `enabled:` на `true`;
* Создать фильтр: `vim /etc/fail2ban/filter.d/twilight.conf`
* Вставить туда:
    ```ssh                                                  
    [INCLUDES]
    before = common.conf
    
    [Definition]
    failregex = ^.* (\[.*\])* Failed bypass token from <HOST> at .*$
    ```
* Создать jail: `vim /etc/fail2ban/jail.d/twilight.conf`
* Вставить туда:
    ```
    [twilight]
    enabled = true
    maxretry = 7
    findtime = 180
    action = iptables-allports[name=twilight, protocol=all]
    bantime = 3600
    filter = twilight
    port = http,https
    logpath = /home/user/Twilight/log/production.log
    ```
  (**Важно!** Не забудьте поменять путь *logpath* на свой. Подробнее про параметры см.выше по ссылке);
* Перезапустить: `systemctl restart fail2ban`

(Забаненные IP можно узнать командой:`sudo fail2ban-client status twilight`)
### Продакшн
Для прода не забыть прекомпилировать ассеты:

`RAILS_ENV=production bundle exec rake assets:precompile`
## Известные баги
* Если есть аттачменты, есть заголовок и отсутствует текст поста, то заголовок не отправляется (фича?);

Блок = сообщение длиной максимум 4096 символов (актуально для телеги);

* [TG] При редактировании существующего поста если блоков поста два и больше, то в сообщении не указывается название (title) поста;
* [TG] Если каналов для поста в telegram два и больше то:
  * Если нет изменений во всех блоках, то текст не изменится;
  * Если есть изменения, то появилтся лишний блок сообщения;
* [TG] Если у поста в telegram был текст и аттачменты, и при редактировании убрать все аттачменты, то пост удалится;
* [TG] Если у аттачмента убрать весь текст, то вне зависимости от заголовка, текст не изменится;
* [TG] При редактировании аттачментов в комментариях (добавление нового и удаление старого) сбивается порядок и при повторном редактировании удаляется не та картинка;

Мне лень их фиксить, кто захочет (было бы очень круто), для тех пункт ниже;

## Контрибьюшен

  1) Форкни проект;
  2) Сделай изменения в форкнутом проекте;
  3) На странице этого репозитория, тыкни Pull Requests и сделай Pull Request, выбрав свой форк в правом списке