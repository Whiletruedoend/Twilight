# Twilight

### Table of Contents
* [Идея](#Идея)
* [Текущие возможности и планы](#Текущие-возможности-и-планы)
* [Поддержка платформ](#Поддержка-платформ)
* [Установка](#Установка)
* [Настройка](#Настройка)
  + [Комментарии](#Комментарии)
  + [Matrix](#matrix)
  + [fail2ban](#fail2ban)
  + [Продакшн](#Продакшн)
* [Известные баги](#Известные-баги)
* [Вопрос к безопасности](#Вопрос-к-безопасности)
* [Схемы и скриншоты](#Схемы-и-скриншоты)
* [Контрибьюшен](#Контрибьюшен)
* [Связь](#Связь)

 <img src="https://i.imgur.com/3QStroz.png"></img>


P.S. Список последних изменений можно посмотреть <a href="https://github.com/Whiletruedoend/Twilight/blob/master/update_log.md">тут</a>

## Идея

Недавно задумался над реализацией блогов в разных платформах, и пришёл к следующим проблемам:
 
 * Первая, это то что нет единой площадки куда можно складывать контент;
 * Вторая, проблема в том что все сидят в разных местах;
 
    из этих двух вытекает:
 
 * Третья - глупость самому постить одно и то же в разные места;
 * Четвёртая - нужно самому сидеть в других платформах;
 
 Поэтому было принято написать что-то вроде агрегатора статей. Всё просто - пишешь пост - он разлетается по разным платформам. Схему и картинки см. в самом конце;
 
 На схеме видно что есть каналы на платформах которые принадлежат владельцу, доступ рядовому пользователю осуществляется с помощью rss токена. Поясняю: каждый зарегистрировавшейся пользователь получает свой токен и использует его для получения новостей с RSS. Это даёт два преимущества:
 
 1) Персонализация с помощью тегов контента, который пользователь хочет видеть;
 2) Ограничение автором прав доступа на некоторые статьи;
 
 Конечно, если мы говорим о размещении статей на других открытых платформах, ограничение прав особо не имеет смысла, однако целью автора не было построение полностью изолированной среды с контролем каждой выходной ноды, хотя бы потому что это практически нереализуемо.
 
 Таблица моделей находится где-то в конце файла;
 
## Текущие возможности и планы
  Смотри доску на github во вкладке `projects`;
 
## Поддержка платформ
 
 * Telegram: 
   * Отправка в платформы: Да
   * Редактирование, удаление: Да
   * Отправка из платформы: Нет
   * Поддержка комментариев: Да
   * Поддержка аттачменов: картинки, видео, аудио, файлы
   
 * Matrix: 
   * Отправка в платформы: Да
   * Редактирование, удаление: Да
   * Отправка из платформы: Нет
   * Поддержка аттачменов: картинки, видео, аудио, файлы
 
 Пока что всё
 
## Установка
 
  * Ставим ruby;
  * Ставим проект: 
  
    ```ssh
     git clone https://github.com/Whiletruedoend/Twilight
     cd Twilight/
     yarn install --check-files
     bundle install
     rails db:migrate
    ```
     
  * Настраиваем: `credentials.yml`
  * Запускаем: `rails s`
  
Теперь сайт будет доступен по адресу: `http://localhost:3080`

## Настройка
Некоторые настройки делаются через консоль (`rails c`), но большинство работает и так при условии правильно введённых данных;
  * После регистрации делаем себя админом (для публикации постов и всего-всего):
      ```ssh
       User.last.update(is_admin: true)
      ```
### Комментарии
Чтобы работали комментарии в Telegram, необходимо:
1. Проверить настройки приватности бота;
2. Добавить бота в чат с комментариями;
3. При добавлении канала поставить галку 'Включить комментарии';

**Далее, парсинг комментариев пока что НЕ запускается автоматически при загрузке rails. Поэтому для запуска нужно::**

1. ~~В config/application.rb закомментировать строку: RunTelegramPoller.perform_later~~ (пока что не нужно)
2. В ручную запустить poller командой: `rake tg:start`

### Matrix
 Краткая инструкция по настройке matrix.
 
 1. Доступ осуществляется через access_token. Его получение через клиент Element: `Все настройки -> Помощь & О программе --> *в самом низу* Токен доступа`
 2. Для получения ID комнаты, создаём комнату, после чего ПКМ на комнате и `Настройки --> Подробности --> и тут 'Внутренний ID комнаты'`
### fail2ban
Для возможности блокировки IP адресов тех, кто пытается сбрутофорсить RSS токен, используется [fail2ban](https://www.dmosk.ru/instruktions.php?object=fail2ban). Инструкция:
* Поставить пакет fail2ban;
* Настроить `credentials.yml`: выставить `enabled:` на `true`;
* Создать фильтр: `vim /etc/fail2ban/filter.d/twilight.conf`
* Вставить туда:
    ```ssh                                                  
    [INCLUDES]
    before = common.conf
    
    [Definition]
    failregex = ^.* (\[.*\])* Failed bypass token from <HOST> at .*$
    ```
* Создать jail: `vim /etc/fail2ban/jail.d/twilight.conf`
* Вставить туда:
    ```
    [twilight]
    enabled = true
    maxretry = 7
    findtime = 180
    action = iptables-allports[name=twilight, protocol=all]
    bantime = 3600
    filter = twilight
    port = http,https
    logpath = /home/user/Twilight/log/production.log
    ```
  (**Важно!** Не забудьте поменять путь *logpath* на свой. Подробнее про параметры см.выше по ссылке);
* Перезапустить: `systemctl restart fail2ban`

(Забаненные IP можно узнать командой:`sudo fail2ban-client status twilight`)
### Темы
Для создания своей темы необходимо создавать файл в формате `app/assets/stylesheets/название_theme.scss`, отредактировать его, затем перезапустить приложение;
### Продакшн
Для прода не забыть прекомпилировать ассеты:

`RAILS_ENV=production bundle exec rake assets:precompile`

## Известные баги
* Если есть аттачменты, есть заголовок и отсутствует текст поста, то заголовок не отправляется (фича?);

Блок = сообщение длиной максимум 4096 символов (актуально для телеги);

* [TG] При редактировании существующего поста если блоков поста два и больше, то в сообщении не указывается название (title) поста;
* [TG] Если каналов для поста в telegram два и больше то:
  * Если нет изменений во всех блоках, то текст не изменится;
  * Если есть изменения, то появилтся лишний блок сообщения;
* [TG] Если у поста в telegram был текст и аттачменты, и при редактировании убрать все аттачменты, то пост удалится;
* [TG] Если у аттачмента убрать весь текст, то вне зависимости от заголовка, текст не изменится;
* [TG] При редактировании аттачментов в комментариях (добавление нового и удаление старого) сбивается порядок и при повторном редактировании удаляется не та картинка;
* [TG] При удалении поста с какого-либо канала, удаляются все комментарии, в т.ч. и привязанные к другим постам. Это связано с тем, что комментарии привязаны к посту, а не к платформе, иначе при просмотре поста пришлось бы показывать разные версии текста (для каждого канала) с разными комментариями. А подразумевается, что пост один (одинаковый), просто на нескольких каналах;
* [ANY] Если удалить канал, а затем удалить пост, то пост из платформ не удалится (нет токенов - нет удаления, вроде логично);
* [TG][TEMP] При добавлении канала нужно вручную перезапускать poller, а то и rails приложение, иначе он не сможет найти бота и создать пост;

Мне лень их фиксить, кто захочет (было бы очень круто), для тех пункт ниже;

## Вопрос к безопасности

Сейчас получается так, что, если у пользователя есть несколько каналов, то даже имея несколько токенов авторизации, для предзагрузки картинок используется какой-то один (самый первый указанный).

Но допустим такую ситуацию: у пользователя есть 2 канала (2 тонена соответственно), и есть второй человек, который знает первый токен, но не знает второй. Тогда исходя из логики, что все аттачменты загружаются во временный канал от первого токена, он может просто перехватить информацию которая предназначалась для второго токена.

Только вот информация с первого токена идентична информации со второго токена (ведь контент заливается на разные каналы один и тот же!), поэтому даже перехватив эту информацию условный злоумышленник в результате получит то же самое.

Поэтому серъёной угрозы это вроде не несёт. Но на всякий случай предупредил, чтобы не было вопросов.
## Схемы и скриншоты
Общая схема:
<img src="https://i.imgur.com/ffeGQGF.png"></img>
Схема моделей:
<img src="https://i.imgur.com/91dyP9L.png"></img>
Главная страница:
<img src="https://i.imgur.com/cVz0Quv.png"></img>
Создание статьи:
<img src="https://i.imgur.com/3QStroz.png"></img>
Список статей:
<img src="https://i.imgur.com/g0adLcy.png"></img>
Конкретная статья:
<img src="https://i.imgur.com/9EvuyNZ.png"></img>
Личный кабинет:
<img src="https://i.imgur.com/jxkMB96.png"></img>

## Контрибьюшен

  1) Форкни проект;
  2) Сделай изменения в форкнутом проекте;
  3) На странице этого репозитория, тыкни Pull Requests и сделай Pull Request, выбрав свой форк в правом списке;
  
## Связь
Если у вас есть какие-то идеи или собственные наработки, или же просто вопросы по поводу работоспособности кода, то вы всегда можете обратиться ко мне по следующим адресам:

- [Matrix](https://matrix.to/#/@whiletruedoend:matrix.org)
- Jabber: whiletruedoend@gensokyo.tk