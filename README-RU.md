# Twilight

Also available EN version => [README.md](https://github.com/Whiletruedoend/Twilight/blob/master/README.md)

### Table of Contents
* [Идея](#Идея)
* [Поддержка платформ](#Поддержка-платформ)
* [Установка](#Установка)
* [Настройка](#Настройка)
  + [Комментарии](#Комментарии)
  + [Matrix](#matrix)
  + [fail2ban](#fail2ban)
  + [Темы](#Темы)
  + [Продакшн](#Продакшн)
* [Текущие возможности](#Текущие-возможности)
* [Баги и некоторые особенности](#Баги-и-некоторые-особенности)
* [Вопрос к безопасности](#Вопрос-к-безопасности)
* [Схемы и скриншоты](#Схемы-и-скриншоты)
* [Contribution](#Contribution)
* [Связь](#Связь)

 <img src="https://i.imgur.com/j6FCqsv.png"></img>


P.S. Список последних изменений можно посмотреть <a href="https://github.com/Whiletruedoend/Twilight/blob/master/update_log.md">тут</a>

## Идея

Анализируя различные сайты-блоги и прилегающие к ним платформы (куда идёт репост), можно выделить главную проблему: Каждая платформа по сути никак не связана ни с другими платформами, ни с блогом. Из этого вытекает:
 
 1. Глупость самому постить одно и то же в разные места;
 2. Необходимость самому сидеть в других платформах;
 
 Поэтому было принято написать что-то вроде агрегатора статей. Идея простая - пишешь пост - он разлетается по разным платформам.
 
 Визуальное представление реализации см. в [Схемы и скриншоты](#Схемы-и-скриншоты);
 
## Поддержка платформ
 
 * Telegram: 
   * Отправка в платформы: Да
   * Редактирование, удаление: Да
   * Отправка из платформы: Нет
   * Поддержка комментариев: Да
   * Поддержка аттачменов: картинки, видео, аудио, файлы
   
 * Matrix: 
   * Отправка в платформы: Да
   * Редактирование, удаление: Да
   * Отправка из платформы: Нет
   * Поддержка аттачменов: картинки, видео, аудио, файлы
 
## Установка

  Есть 2 способа установки:

  ### Обычный
 
  * Установить ruby (2.7.7):
    * Для [rvm](https://rvm.io/):
    ```ssh
     rvm install ruby-2.7.7
    ```
    * Для [rbenv](https://github.com/rbenv/rbenv):
    ```ssh
     rbenv install 2.7.7
    ```
  * Установить yarn: [Windows](https://github.com/yarnpkg/yarn/releases/download/v1.22.19/yarn-1.22.19.msi) | [Linux](https://www.ubuntupit.com/how-to-install-and-configure-yarn-on-linux-distributions/);
  * Установить redis: [Windows](https://github.com/tporadowski/redis/releases) | [Linux](https://redis.io/docs/getting-started/);
  * (Не обязательно) Установить [PostgreSQL](https://www.enterprisedb.com/downloads/postgres-postgresql-downloads);
  * Загрузить проект: 
  
    ```ssh
     git clone https://github.com/Whiletruedoend/Twilight
     cd Twilight/
     yarn install --check-files
     bundle install
     rails db:migrate
    ```
     
  * Настроить: `config/credentials.yml`
  * Запустить сервер командой: `rails s`

  ### Docker

  * Загрузить проект:
  ```
  git clone https://github.com/Whiletruedoend/Twilight
  cd Twilight/
  ```
  * (Не обязательно) Настроить файл .env для подключения к существующей бд postgres, или изменить тип бд на sqlite3 в config/database.yml
  * Настроить config/credentials.yml
  * Выполнить команду:
  ```
    docker-compose build web
  ```
  * После успешной сборки образа, выполнить:
  ```
    docker-compose up web
  ```
  * (Если требуется использовать postgres из docker'a, выполнить):
  ```
    docker-compose up db
  ```
  * (Если нужно выполнить миграции, то):
  ```
    docker-compose run --rm web bin/rails db:migrate
  ```
  * Чтобы сделать себя админом и в контейнере изменять credentials.yml и database.yml, нужно войти в контейнер командой:
  ```
    docker exec -it twilight-web-1 /bin/bash 
  ```

Теперь сайт будет доступен по адресу: `http://localhost:3080`

## Настройка

[Production] Не забудьте настроить переменную secret_key_base в файле credentials.tml!

Некоторые настройки делаются через консоль (`rails c`), но большинство работает и так при условии правильно введённых данных;

Чтобы иметь возможность создавать посты, необходимо получить права администратора:
  ```ssh
    User.where(login: "ВАШЛОГИН").update(is_admin: true)
  ```
### Комментарии
Для поддержки трансляции комментариев из Telegram в пост блога, необходимо:
1. Проверить настройки приватности бота;
2. Добавить бота в чат с комментариями;
3. При добавлении канала поставить галку 'Включить комментарии';

После чего трансляция комментариев должен заработать.

### Matrix
 Краткая инструкция по настройке matrix.
 
 1. Доступ осуществляется через access_token. Его получение через клиент Element: `Все настройки -> Помощь & О программе --> *в самом низу* Токен доступа`
 2. Для получения ID комнаты, создаём комнату, после чего ПКМ на комнате и `Настройки --> Подробности --> и тут 'Внутренний ID комнаты'`
### fail2ban
Для возможности блокировки IP адресов тех, кто пытается сбрутофорсить RSS токен, используется [fail2ban](https://www.dmosk.ru/instruktions.php?object=fail2ban). Инструкция:
* Установить пакет fail2ban;
* Настроить `credentials.yml`: выставить `enabled:` на `true`;
* Создать фильтр: `vim /etc/fail2ban/filter.d/twilight.conf`
* Вставить туда код ниже:
    ```ssh                                                  
    [INCLUDES]
    before = common.conf
    
    [Definition]
    failregex = ^.* (\[.*\])* Failed bypass token from <HOST> at .*$
    ```
* Создать jail: `vim /etc/fail2ban/jail.d/twilight.conf`
* Вставить туда код ниже:
    ```
    [twilight]
    enabled = true
    maxretry = 7
    findtime = 180
    action = iptables-allports[name=twilight, protocol=all]
    bantime = 3600
    filter = twilight
    port = http,https
    logpath = /home/user/Twilight/log/production.log
    ```
  (**Важно!** Не забудьте поменять путь *logpath* на свой. Подробнее про параметры см.выше по ссылке);
* Перезапустить сервис: `systemctl restart fail2ban`

(Забаненные IP можно узнать командой:`sudo fail2ban-client status twilight`)
### Темы
Для создания своей темы необходимо создать файл в формате `app/assets/stylesheets/название_theme.scss`, отредактировать его, затем перезапустить приложение;
### Продакшн
Для прода не забыть прекомпилировать ассеты:

`RAILS_ENV=production bundle exec rake assets:precompile`

## Текущие возможности
  
  * Поддержка EN/RU языков;
  * Возможность создавать/менять темы;
  * Управление каналами, проверка данных при вводе (только для администраторов);
  * Поиск заметки по заголовку на главной странице;
  * Каптча при авторизации/регистрации;
  * Система инвайт-кодов (не обязательно);
  * Поддержка отдельных опций для каждой платформы;
  * Спецификаторы доступа заметки (для всех, для пользователей, для себя);
  * Создание/Удаление тэгов, возможность пользователя выбрать нужные тэги (результат отображается в RSS);
  * Возможность добавления комментариев к записи;
  * Просмотр статистики зарегистрированных пользователей (только для администраторов);
  * Twitter-style feed;

## Баги и некоторые особенности
Особенности:
* [TG] Если есть заголовок, но отсутствует текст поста, то заголовок не отправляется;
* [TG] При удалении поста с какого-либо канала, удаляются все комментарии, в т.ч. и привязанные к другим постам. Это связано с тем, что комментарии привязаны к посту, а не к платформе, иначе при просмотре поста пришлось бы показывать разные версии текста (для каждого канала) с разными комментариями. А подразумевается, что пост один (одинаковый), просто на нескольких каналах;
* [TG] Если у поста в telegram был текст и аттачменты, и при редактировании убрать все аттачменты, то пост полностью удалится. Это особенность телеги, я не могу превратить подпись в текст, нужно создавать новый пост;
* [TG] Если вы отправляете несколько аттачментов разного типа и используете подпись, то аттачменты будут сгруппированы по группам, первой группой будет такого же типа как и первый аттачмент, и подпись будет прикреплена именно к ней;
* [TG] Если был создан пост с <= 4096 символами и при обновлении поста его длина будет превышать 4096 символов, то будет создано новое сообщение, которое может быть на дальнем расстоянии от первого (например, если были ещё посты то оно будет идти после них). Переместить сообщение вверх я не могу, поэтому советую использовать опцию onlylink в таких случаях;
* [ANY] Если удалить канал, а затем удалить пост, то пост из платформ не удалится (нет токенов - нет удаления, вроде логично);

Баги:

* [TG] При редактировании аттачментов в комментариях (добавление нового и удаление старого) сбивается порядок и при повторном редактировании удаляется не та картинка;

Мне лень их фиксить, кто захочет (было бы очень круто), то с радостью приму Pull Request;

### Вопрос к безопасности

Сейчас получается так, что, если у пользователя есть несколько каналов, то даже имея несколько токенов авторизации, для предзагрузки картинок (аттачментов) используется какой-то один (самый первый указанный).

Но допустим такую ситуацию: у пользователя есть 2 канала (2 тонена соответственно), и есть второй человек, который знает первый токен, но не знает второй. Тогда исходя из логики, что все аттачменты загружаются во временный канал от первого токена, он может просто перехватить информацию которая предназначалась для второго токена.

Только вот информация с первого токена идентична информации со второго токена (ведь контент заливается на разные каналы один и тот же!), поэтому даже перехватив эту информацию условный злоумышленник в результате получит то же самое.

Поэтому серъёной угрозы это вроде не несёт. Но на всякий случай предупредил, чтобы не было вопросов.
## Схемы и скриншоты
ER-диаграмма:
<img src="https://i.imgur.com/RQQCRpa.jpeg"></img>
Главные страницы (настраивается):
 * Вариант 0 (отдельная страница):
<img src="https://i.imgur.com/cVz0Quv.png"></img>
 * Вариант 1 [По-умолчанию] (posts):
 <img src="https://i.imgur.com/j6FCqsv.png"></img>
 * Вариант 2: (feed):
 <img src="https://i.imgur.com/FJ7z6vF.png"></img>

Личный кабинет:
<img src="https://i.imgur.com/XDwP5n0.png"></img>
Управление каналами:
<img src="https://i.imgur.com/ojERlTd.png"></img>
Инвайт-коды:
<img src="https://i.imgur.com/FvAlzzT.png"></img>
Статистика:
<img src="https://i.imgur.com/WxAdMuD.png"></img>
Создание статьи (Default theme):
<img src="https://i.imgur.com/3QStroz.png"></img>
Конкретная статья:
<img src="https://i.imgur.com/9F0W2Nr.png"></img>
## Contribution

  1) Сделать fork проекта;
  2) Сделать изменения в этом проекте;
  3) На странице этого репозитория, нажать Pull Requests и сделать Pull Request, выбрав свой fork в правом списке;
  
## Связь
Если у вас есть какие-то идеи или собственные наработки, или же просто вопросы по поводу работоспособности кода, то вы всегда можете обратиться ко мне по следующим адресам:

- [Matrix](https://matrix.to/#/@whiletruedoend:matrix.org)